<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Опрос ДНП "Клеймёново-2"</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    {% include 'analytics.html' %}
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0 24px 0;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            position: relative;
        }
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.18);
        }
        header p {
            font-size: 1.2em;
            opacity: 0.93;
            margin-bottom: 20px;
        }
        .progress-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }
        .progress-bar {
            height: 9px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-bar-fill {
            height: 100%;
            background: #27ae60;
            border-radius: 3px;
            width: 50%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(39,174,96,0.3);
        }
        .progress-text {
            font-size: 0.9em;
            opacity: 0.95;
            text-align: center;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.10);
            border: 1px solid #e1e5e9;
        }
        .card h2 {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }
        .situation-card {
            border-left: 5px solid #e74c3c;
        }
        .legal-card {
            border-left: 5px solid #f39c12;
        }
        .negative-card {
            border-left: 5px solid #c0392b;
        }
        .survey-card {
            border-left: 5px solid #27ae60;
            background: linear-gradient(135deg, #f8ffff 0%, #f0fff4 100%);
        }
        ul {
            margin: 15px 0;
            padding-left: 25px;
        }
        li {
            margin-bottom: 10px;
            line-height: 1.8;
        }
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            font-family: inherit;
            box-sizing: border-box;
            background: #fff;
        }
        select {
            min-width: 0;
            font-size: 16px;
            padding: 12px 40px 12px 15px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            background: #fff;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 18px 18px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
        }
        .input-error {
            border-color: #e74c3c !important;
            box-shadow: 0 0 0 3px rgba(231,76,60,0.12) !important;
        }
        .input-success {
            border-color: #27ae60 !important;
            box-shadow: 0 0 0 3px rgba(39,174,96,0.13) !important;
        }
        .radio-group {
            display: flex;
            gap: 32px;
            margin: 0;
            padding: 0;
            align-items: center;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
            padding: 0;
        }
        .radio-option input[type="radio"] {
            margin: 0;
            padding: 0;
            width: 15px;
            height: 15px;
            display: inline-block;
            vertical-align: middle;
        }
        .btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39,174,96,0.3);
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            header h1 { font-size: 2em; }
            .card { padding: 20px; }
        }
        .consent-row {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .consent-row input[type="checkbox"] {
            width: auto;
            margin: 0;
            padding: 0;
        }
        .consent-row label {
            display: inline;
            margin-bottom: 0;
            margin-left: 12px;
            flex: 1;
        }
        .stats-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .stats-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .card-red-bg {
            background: #fff6f7;
        }
        .card-yellow-bg {
            background: #fffbe9;
        }
        .card-blue-bg {
            background: #f4f8ff;
        }
        .card-green-bg {
            background: #f4fff7;
        }
        .card-purple-bg {
            background: #faf6ff;
        }
        .answers-box {
            background: #fff;
            border-radius: 10px;
            padding: 18px 20px 12px 20px;
            margin-top: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.04);
            border: 1px solid #e1e5e9;
        }
        
        /* Модальное окно */
        .modal {
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
        }
        
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 20px;
        }
        
        .close:hover {
            color: #333;
        }
        
        .code-input-container {
            margin: 25px 0;
            text-align: center;
        }
        
        #codeInput {
            font-size: 24px;
            text-align: center;
            letter-spacing: 8px;
            font-weight: bold;
            width: 200px;
            padding: 15px;
            border: 3px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        #codeInput:focus {
            border-color: #3498db;
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-secondary:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ДНП "Клеймёново-2"</h1>
            <p>Информация о ликвидации и создании нового СНТ</p>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="progress-text">Шаг 1 из 2: Заполните основную информацию</div>
            </div>
            <a href="/stats" class="stats-btn">Статистика</a>
        </header>

        <div class="card card-yellow-bg" style="border-left: 5px solid #ffe58f;">
            <div class="answers-box">
                <h2>
                    <span style="font-size:1.3em; margin-right:8px;">📝</span>
                    <strong>Опрос жителей о будущем управления посёлком</strong>
                </h2>
                <ul>
                    <li>Это опрос для выяснения мнения жителей о необходимости создания нового юридического лица (СНТ) для управления нашим посёлком.</li>
                    <li>В данный момент ДНП "Клеймёново-2" находится на стадии ликвидации, и по факту никто не представляет интересы посёлка.</li>
                    <li>Ниже приведены факты и данные о ходе ликвидации.</li>
                    <li>Просим пройти опрос, чтобы понять — нужно ли создавать новое СНТ или оставить всё как есть.</li>
                </ul>
                <div class="highlight" style="background: #fffbe6; border-left: 4px solid #ffe58f; margin-top: 18px;">
                    <strong>Важное:</strong> создание нового СНТ — это не обязательство, а только возможность. Если СНТ не создавать, старый ДНП будет ликвидирован, и возможны юридические последствия (например, уберут субсидию на свет).
                </div>
            </div>
        </div>
        <div class="card card-red-bg situation-card" style="border-left: 5px solid #e74c3c;">
            <div class="answers-box">
                <h2>🚨 Текущая ситуация</h2>
                <ul>
                    <li><strong>Дачное некоммерческое партнёрство "Клеймёново-2"</strong> (ОГРН 1085043000624) зарегистрировано 08.02.2008.</li>
                    <li>Адрес: 142204, Московская область, г. Серпухов, ул. Крюкова, д.10.</li>
                    <li>В 2022 году в ЕГРЮЛ внесены сведения о недостоверности данных о юридическом лице.</li>
                    <li>07.04.2025 налоговым органом принято решение о предстоящем исключении ДНП "Клеймёново-2" из ЕГРЮЛ (решение №6336).</li>
                    <li>Решение опубликовано в "Вестнике государственной регистрации" №14 от 09.04.2025.</li>
                    <li>Последний председатель: Васильев Андрей Геннадьевич (назначен 07.04.2018).</li>
                </ul>
            </div>
        </div>
        <div class="card card-yellow-bg legal-card" style="border-left: 5px solid #f39c12;">
            <div class="answers-box">
                <h2>⚖️ Правовая база</h2>
                <ul>
                    <li>Исключение юридического лица из ЕГРЮЛ производится на основании ст. 21.1 Федерального закона №129-ФЗ "О государственной регистрации юридических лиц и индивидуальных предпринимателей".</li>
                    <li>Причина — наличие в ЕГРЮЛ сведений о недостоверности данных.</li>
                    <li>Все сведения подтверждены выпиской из ЕГРЮЛ от 03.06.2025 (<a href="/static/ЕГРЮЛ_выписка.pdf" target="_blank">PDF</a>).</li>
                </ul>
            </div>
        </div>
        <div class="card card-green-bg positive-card" style="border-left: 5px solid #27ae60;">
            <div class="answers-box">
                <h2>🌱 Положительные стороны создания нового СНТ</h2>
                <ul>
                    <li><strong>Появится официальный представитель</strong> (председатель), который будет защищать интересы жителей.</li>
                    <li><strong>Прозрачная бухгалтерия и отчётность</strong> — все расходы и доходы будут фиксироваться и доступны для проверки.</li>
                    <li><strong>Возможность автоматизации платежей</strong> (через сайт, бота, банковские сервисы).</li>
                    <li><strong>Организованное благоустройство территории</strong> (дороги, освещение, озеленение, уборка).</li>
                    <li><strong>Повышение стоимости участков</strong> за счёт порядка и инфраструктуры.</li>
                    <li><strong>Коллективное решение вопросов</strong> (газ, вода, интернет, охрана, мусор).</li>
                    <li><strong>Легальный статус</strong> для заключения договоров с подрядчиками и коммунальными службами.</li>
                    <li><strong>Возможность получать субсидии и участвовать в госпрограммах.</strong></li>
                    <li><strong>Упрощение коммуникации между жителями</strong> (чат, сайт, рассылки).</li>
                    <li><strong>Повышение привлекательности посёлка</strong> для новых жителей и инвесторов.</li>
                </ul>
            </div>
        </div>
        <div class="card card-red-bg negative-card" style="border-left: 5px solid #c0392b;">
            <div class="answers-box">
                <h2>⚠️ Возможные сложности при создании нового СНТ</h2>
                <p>Важно понимать, что новое СНТ будет иметь определённые обязательства:</p>
                <ul>
                    <li><strong>Финансовые обязательства:</strong>
                        <ul>
                            <li>Ежемесячные взносы на содержание инфраструктуры</li>
                            <li>Зарплата председателя и бухгалтера</li>
                            <li>Расходы на ведение отчётности</li>
                            <li>Налоги и сборы</li>
                        </ul>
                    </li>
                    <li><strong>Административные обязательства:</strong>
                        <ul>
                            <li>Ведение реестра членов СНТ</li>
                            <li>Подача отчётов в налоговую и муниципалитет</li>
                            <li>Проведение обязательных собраний</li>
                            <li>Документооборот и делопроизводство</li>
                        </ul>
                    </li>
                    <li><strong>Инфраструктурные обязательства:</strong>
                        <ul>
                            <li>Организация вывоза мусора (установка контейнеров, договор с управляющей компанией)</li>
                            <li>Содержание дорог в надлежащем состоянии</li>
                            <li>Обслуживание электросетей (при необходимости)</li>
                            <li>Уборка общественных территорий</li>
                        </ul>
                    </li>
                    <li><strong>Правовые обязательства:</strong>
                        <ul>
                            <li>Соответствие требованиям законодательства</li>
                            <li>Ответственность перед муниципалитетом</li>
                            <li>Исполнение предписаний контролирующих органов</li>
                        </ul>
                    </li>
                </ul>
                <div class="highlight">
                    <strong>Важно:</strong> Сейчас, при отсутствии действующего ДНП, жители фактически не несут организованных расходов на содержание территории, но и не могут рассчитывать на организованное решение общих вопросов.
                </div>
            </div>
        </div>
        <div class="card survey-card">
            <h2>📝 Опрос жителей</h2>
            <p>Пожалуйста, заполните форму ниже. Ваше мнение важно для принятия решения о создании нового СНТ.</p>
        <form id="survey-form">
                <div class="form-group">
                    <label for="fio">ФИО</label>
                    <input type="text" id="fio" name="fio" required 
                           pattern="^[А-Яа-яЁёA-Za-z\-\s]{2,}$"
                           title="ФИО должно содержать минимум 2 символа (только буквы, пробелы и дефисы)">
                </div>
                <div class="form-group">
                    <label for="phone">Телефон</label>
                    <input type="tel" id="phone" name="phone" required pattern="^\+7\s?\(\d{3}\)\s?\d{3}-\d{2}-\d{2}$" placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="kadastr_select">Кадастровый номер участка</label>
                    <select id="kadastr_select" name="kadastr_select" required>
                        <option value="">Выберите вариант</option>
                        <option value="has">Указать кадастровый номер</option>
                        <option value="none">Нет кадастрового номера</option>
                    </select>
                    <input type="text" id="kadastr" name="kadastr" style="display:none; margin-top:10px;"
                           pattern="^\d{2}:\d{2}:\d{7}:\d{4}$"
                           placeholder="50:XX:XXXXXXX:XXXX"
                           title="Кадастровый номер должен быть в формате XX:XX:XXXXXXX:XXXX (где X - цифры)">
                    <div class="highlight" style="margin-top:10px;">
                        Ответы на вопросы ниже будут учтены только если вы укажете кадастровый номер. Без кадастрового номера в статистики учитываются ответы на вопросы второй страницы.
                    </div>
                </div>
                <div class="form-group">
                    <label for="snt_support">Готовы ли вы участвовать в создании нового СНТ?</label>
                    <select id="snt_support" name="snt_support" required>
                        <option value="">Выберите вариант</option>
                        <option value="Да">Да</option>
                        <option value="Нет">Нет</option>
                        <option value="Затрудняюсь">Затрудняюсь</option>
                        <option value="Оставить всё как есть">Оставить всё как есть</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment_ready">Готовы ли вы к ежемесячным взносам на содержание СНТ?</label>
                    <select id="payment_ready" name="payment_ready" required>
                        <option value="">Выберите вариант</option>
                        <option value="Да">Да</option>
                        <option value="Нет">Нет</option>
                        <option value="Зависит от суммы">Зависит от суммы</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="consent-row">
                        <input type="checkbox" name="consent" id="consent-checkbox" required>
                        <label for="consent-checkbox">
                            Я подтверждаю согласие на обработку персональных данных
                            (<a href="/consent" target="_blank" id="consent-link">подробнее</a>)
                        </label>
                    </div>
                </div>
                <button type="submit" class="btn">Перейти к расширенному опросу</button>
        </form>
        <div id="thanks" style="display:none;">
            <h2>Спасибо за участие!</h2>
        </div>
    </div>
        <div class="footer">
            <p>Инициативная группа жителей ДНП "Клеймёново-2" | 2025</p>
            <p>Ваши данные обрабатываются конфиденциально</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="{{ url_for('static', path='consent.js') }}"></script>
    <script>
        // Форматирование телефона
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value[0] === '8') value = '7' + value.slice(1);
                if (value[0] !== '7') value = '7' + value;
            }
            let formatted = '+7';
            if (value.length > 1) {
                formatted += ' (' + value.slice(1, 4);
                if (value.length > 4) {
                    formatted += ') ' + value.slice(4, 7);
                    if (value.length > 7) {
                        formatted += '-' + value.slice(7, 9);
                        if (value.length > 9) {
                            formatted += '-' + value.slice(9, 11);
                        }
                    }
                }
            }
            e.target.value = formatted;
        });
        // --- Кадастровый номер: логика выпадающего списка ---
        const kadastrSelect = document.getElementById('kadastr_select');
        const kadastrInput = document.getElementById('kadastr');
        const sntSupportGroup = document.getElementById('snt_support').closest('.form-group');
        const paymentReadyGroup = document.getElementById('payment_ready').closest('.form-group');
        kadastrSelect.addEventListener('change', function() {
            if (this.value === 'has') {
                kadastrInput.style.display = '';
                kadastrInput.required = true;
                sntSupportGroup.style.display = '';
                paymentReadyGroup.style.display = '';
            } else {
                kadastrInput.style.display = 'none';
                kadastrInput.required = false;
                kadastrInput.value = '';
                kadastrInput.classList.remove('input-error', 'input-success');
                // Скрываем вопросы про СНТ и взносы
                sntSupportGroup.style.display = 'none';
                paymentReadyGroup.style.display = 'none';
                // Сбрасываем значения
                document.getElementById('snt_support').value = '';
                document.getElementById('payment_ready').value = '';
            }
        });
        // Обработка отправки формы
        document.getElementById('survey-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (Array.isArray(data[key])) {
                        data[key].push(value);
                    } else {
                        data[key] = [data[key], value];
                    }
                } else {
                    data[key] = value;
                }
            }
            // --- Кадастровый номер: если не выбран, пишем null ---
            if (data.kadastr_select === 'none') {
                data.kadastr = null;
            }
            
            // --- Проверка незавершенных анкет ---
            const unfinishedRes = await fetch('/survey/check_unfinished', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: data.email,
                    kadastr: data.kadastr,
                    phone: data.phone
                })
            }).then(r => r.json());
            
            if (unfinishedRes.has_unfinished) {
                const continueChoice = confirm(
                    `Найдена незавершенная анкета от ${new Date(unfinishedRes.created_at).toLocaleString('ru-RU')}.\n\n` +
                    `Вы можете продолжить её заполнение.\n\n` +
                    `Хотите продолжить? На ваш email будет отправлен код подтверждения.`
                );
                
                if (continueChoice) {
                    // Отправляем код и открываем модальное окно
                    showCodeModal(data.email, unfinishedRes.session_id);
                    return;
                } else {
                    // Пользователь не хочет продолжать - прерываем процесс
                    alert('Для заполнения нового опроса необходимо завершить предыдущий.');
                    return;
                }
            }
            
            // --- Проверка уникальности завершенных анкет ---
            const checkRes = await fetch('/survey/check_unique', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: data.email,
                    kadastr: data.kadastr,
                    phone: data.phone
                })
            }).then(r => r.json());
            let hasError = false;
            if (checkRes.email_exists) {
                email.classList.add('input-error');
                email.classList.remove('input-success');
                hasError = true;
            }
            if (checkRes.kadastr_exists) {
                kadastr.classList.add('input-error');
                kadastr.classList.remove('input-success');
                hasError = true;
            }
            if (checkRes.phone_exists) {
                phone.classList.add('input-error');
                phone.classList.remove('input-success');
                hasError = true;
            }
            if (hasError) {
                alert('Пользователь с такими данными уже заполнял опрос! Проверьте email, телефон и кадастровый номер.');
                return;
            }
            // --- Если всё ок, продолжаем как раньше ---
            // Генерируем session_id
            const session_id = crypto.randomUUID();
            data.session_id = session_id;
            // Собираем ответы для /survey/base
            const answers = [
                { question_id: 1, value: data.fio },
                { question_id: 3, value: data.phone },
                { question_id: 18, value: data.email },
                { question_id: 2, value: data.kadastr },
                { question_id: 4, value: data.snt_support },
                { question_id: 5, value: data.payment_ready }
            ];
            // Отправляем на /survey/base
            await fetch('/survey/base', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id,
                    answers,
                    consent: data.consent || false,
                    screenshot: null
                })
            });
            localStorage.setItem('session_id', session_id);
            localStorage.setItem('surveyBase', JSON.stringify(data));
            localStorage.setItem('autoConsent', '1');
            let iframe = document.createElement('iframe');
            iframe.style.opacity = '0.01';
            iframe.style.position = 'fixed';
            iframe.style.left = '0';
            iframe.style.top = '0';
            iframe.style.width = '600px';
            iframe.style.height = '800px';
            iframe.style.zIndex = '9999';
            iframe.src = '/consent';
            document.body.appendChild(iframe);
            setTimeout(() => {
                document.body.removeChild(iframe);
                localStorage.removeItem('autoConsent');
                window.location.href = '/details';
            }, 2000);
        });
        // Сохраняем данные в localStorage при клике на ссылку "подробнее"
        document.getElementById('consent-link').addEventListener('click', function() {
            const fio = document.getElementById('fio').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const kadastr = document.getElementById('kadastr').value;
            const snt_support = document.getElementById('snt_support').value;
            const payment_ready = document.getElementById('payment_ready').value;
            localStorage.setItem('surveyBase', JSON.stringify({ fio, phone, email, kadastr, snt_support, payment_ready, consent }));
        });
        const consentCheckbox = document.querySelector('input[name="consent"]');
        if (consentCheckbox) {
            consentCheckbox.addEventListener('change', function() {
                const fio = document.getElementById('fio').value;
                const phone = document.getElementById('phone').value;
                const email = document.getElementById('email').value;
                const kadastr = document.getElementById('kadastr').value;
                const snt_support = document.getElementById('snt_support').value;
                const payment_ready = document.getElementById('payment_ready').value;
                const consent = consentCheckbox.checked;
                localStorage.setItem('surveyBase', JSON.stringify({ fio, phone, email, kadastr, snt_support, payment_ready, consent }));
            });
        }
        // --- ВАЛИДАЦИЯ ---
        function validateFio(fio) {
            return /^[А-Яа-яЁёA-Za-z\-\s]{2,}$/.test(fio.trim());
        }
        function validatePhone(phone) {
            return /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/.test(phone.trim());
        }
        function validateEmail(email) {
            return /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email.trim());
        }
        function validateKadastr(kadastr) {
            return /^\d{2}:\d{2}:\d{7}:\d{4}$/.test(kadastr.trim());
        }
        function setValidationClass(input, valid) {
            input.classList.remove('input-error', 'input-success');
            if (input.value === '') return;
            if (valid) {
                input.classList.add('input-success');
            } else {
                input.classList.add('input-error');
            }
        }
        const fio = document.getElementById('fio');
        const phone = document.getElementById('phone');
        const email = document.getElementById('email');
        const kadastr = document.getElementById('kadastr');
        fio.addEventListener('input', function() {
            setValidationClass(this, validateFio(this.value));
        });
        phone.addEventListener('input', function() {
            setValidationClass(this, validatePhone(this.value));
        });
        email.addEventListener('input', function() {
            setValidationClass(this, validateEmail(this.value));
        });
        kadastr.addEventListener('input', function() {
            setValidationClass(this, validateKadastr(this.value));
        });
        fio.addEventListener('blur', function() {
            setValidationClass(this, validateFio(this.value));
        });
        phone.addEventListener('blur', function() {
            setValidationClass(this, validatePhone(this.value));
        });
        email.addEventListener('blur', function() {
            setValidationClass(this, validateEmail(this.value));
        });
        kadastr.addEventListener('blur', function() {
            setValidationClass(this, validateKadastr(this.value));
        });
        
        // ===== ФУНКЦИИ ДЛЯ РАБОТЫ С МОДАЛЬНЫМ ОКНОМ =====
        
        let currentEmail = '';
        let currentSessionId = '';
        let resendTimer = null;
        
        function showCodeModal(email, sessionId) {
            currentEmail = email;
            currentSessionId = sessionId;
            
            const modal = document.getElementById('codeModal');
            const codeInput = document.getElementById('codeInput');
            const errorDiv = document.getElementById('codeError');
            
            // Очищаем форму
            codeInput.value = '';
            errorDiv.style.display = 'none';
            
            // Показываем модальное окно
            modal.style.display = 'block';
            
            // Фокус на поле ввода
            setTimeout(() => codeInput.focus(), 100);
            
            // Отправляем код
            sendVerificationCode(email, sessionId);
        }
        
        function hideCodeModal() {
            const modal = document.getElementById('codeModal');
            modal.style.display = 'none';
            if (resendTimer) {
                clearInterval(resendTimer);
                resendTimer = null;
            }
        }
        
        async function sendVerificationCode(email, sessionId) {
            const resendBtn = document.getElementById('resendCodeBtn');
            const resendTimer = document.getElementById('resendTimer');
            
            try {
                const response = await fetch('/survey/send_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, session_id: sessionId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Код отправлен на вашу почту');
                    startResendTimer(120); // 2 минуты
                } else {
                    showError(result.message);
                    if (result.seconds_until_new_request > 0) {
                        startResendTimer(result.seconds_until_new_request);
                    }
                }
            } catch (error) {
                showError('Ошибка отправки кода. Попробуйте позже.');
            }
        }
        
        async function verifyCode() {
            const codeInput = document.getElementById('codeInput');
            const code = codeInput.value.trim();
            
            if (code.length !== 6) {
                showError('Введите 6-значный код');
                return;
            }
            
            const verifyBtn = document.getElementById('verifyCodeBtn');
            const originalText = verifyBtn.textContent;
            verifyBtn.textContent = 'Проверяем...';
            verifyBtn.disabled = true;
            
            try {
                const response = await fetch('/survey/verify_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentEmail,
                        code: code,
                        session_id: currentSessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Код подтвержден! Переходим к анкете...');
                    // Сохраняем session_id и переходим к details
                    localStorage.setItem('session_id', currentSessionId);
                    setTimeout(() => {
                        hideCodeModal();
                        window.location.href = '/details';
                    }, 1500);
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('Ошибка проверки кода. Попробуйте позже.');
            } finally {
                verifyBtn.textContent = originalText;
                verifyBtn.disabled = false;
            }
        }
        
        function startResendTimer(seconds) {
            const resendBtn = document.getElementById('resendCodeBtn');
            const timerSpan = document.getElementById('resendTimer');
            
            resendBtn.disabled = true;
            let remaining = seconds;
            
            function updateTimer() {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                timerSpan.textContent = `(${minutes}:${secs.toString().padStart(2, '0')})`;
                
                if (remaining <= 0) {
                    resendBtn.disabled = false;
                    timerSpan.textContent = '';
                    clearInterval(resendTimer);
                    resendTimer = null;
                } else {
                    remaining--;
                }
            }
            
            updateTimer();
            resendTimer = setInterval(updateTimer, 1000);
        }
        
        function showMessage(message) {
            const messageP = document.getElementById('codeModalMessage');
            messageP.textContent = message;
            messageP.style.color = '#27ae60';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('codeError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Обработчики событий для модального окна
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('codeModal');
            const closeBtn = modal.querySelector('.close');
            const verifyBtn = document.getElementById('verifyCodeBtn');
            const resendBtn = document.getElementById('resendCodeBtn');
            const codeInput = document.getElementById('codeInput');
            
            // Закрытие модального окна
            closeBtn.addEventListener('click', hideCodeModal);
            
            // Закрытие по клику вне модального окна
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    hideCodeModal();
                }
            });
            
            // Подтверждение кода
            verifyBtn.addEventListener('click', verifyCode);
            
            // Повторная отправка кода
            resendBtn.addEventListener('click', function() {
                if (!this.disabled) {
                    sendVerificationCode(currentEmail, currentSessionId);
                }
            });
            
            // Ввод только цифр в поле кода
            codeInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
            
            // Подтверждение по Enter
            codeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyCode();
                }
            });
        });
    </script>
    
    <!-- Модальное окно для ввода кода -->
    <div id="codeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Введите код подтверждения</h2>
            <p id="codeModalMessage">Код отправлен на вашу почту. Введите его ниже:</p>
            
            <div class="code-input-container">
                <input type="text" id="codeInput" maxlength="6" placeholder="000000" 
                       pattern="[0-9]{6}" autocomplete="off">
            </div>
            
            <div class="modal-buttons">
                <button id="verifyCodeBtn" class="btn">Подтвердить</button>
                <button id="resendCodeBtn" class="btn btn-secondary" disabled>
                    Отправить новый код <span id="resendTimer"></span>
                </button>
            </div>
            
            <div id="codeError" class="error-message" style="display: none;"></div>
        </div>
    </div>
    
</body>
</html>